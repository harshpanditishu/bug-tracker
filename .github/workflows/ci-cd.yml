name: CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

jobs:
  backend-unit-tests:
    name: Backend Unit Tests
    runs-on: ubuntu-latest
    container:
      image: golang:1.21
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Go cache
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/go-build
            ~/go/pkg/mod
          key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
          restore-keys: |
            ${{ runner.os }}-go-
      
      - name: Run Go tests
        working-directory: bugtracker-backend
        run: |
          set -e
          go test -v ./... 2>&1 | tee test-output.log
          go test -v ./... -json | tee test-results.json
      
      - name: Install go-junit-report
        run: go install github.com/jstemmer/go-junit-report/v2@latest
      
      - name: Generate JUnit XML report
        working-directory: bugtracker-backend
        run: |
          cat test-output.log | go-junit-report -set-exit-code > test-results.xml || true
      
      - name: Generate code coverage report
        working-directory: bugtracker-backend
        run: |
          mkdir -p coverage-reports
          go test -coverprofile=coverage.out ./...
          go tool cover -html=coverage.out -o coverage-reports/coverage.html
      
      - name: Publish test results
        uses: EnricoMi/publish-unit-test-result-action@v2
        if: always()
        with:
          files: bugtracker-backend/test-results.xml
          check_name: Backend Unit Test Results
      
      - name: Upload backend test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: backend-test-results
          path: bugtracker-backend/test-results.xml
      
      - name: Upload backend coverage report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: backend-coverage-report
          path: bugtracker-backend/coverage-reports/
  
  frontend-unit-tests:
    name: Frontend Unit Tests
    runs-on: ubuntu-latest
    container:
      image: node:20-alpine
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Install dependencies
        working-directory: bugtracker-frontend
        run: npm install
      
      - name: Run Jest tests
        working-directory: bugtracker-frontend
        run: npm test -- --watchAll=false
      
      - name: Generate code coverage report
        working-directory: bugtracker-frontend
        run: npm run test -- --coverage --coverageReporters=html
      
      - name: Publish test results
        uses: EnricoMi/publish-unit-test-result-action@v2
        if: always()
        with:
          files: bugtracker-frontend/test-results.xml
          check_name: Frontend Unit Test Results
      
      - name: Upload frontend test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: frontend-test-results
          path: bugtracker-frontend/test-results.xml
      
      - name: Upload frontend coverage report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: frontend-coverage-report
          path: bugtracker-frontend/coverage/
  
  launch-application:
    name: Launch Application
    runs-on: ubuntu-latest
    needs: [backend-unit-tests, frontend-unit-tests]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Build and start services
        run: docker compose up --build -d
      
      - name: Wait for backend health
        run: |
          timeout 60 sh -c 'until curl -f http://localhost:8080/api/health; do sleep 2; done' || exit 1
      
      - name: Wait for frontend
        run: |
          timeout 60 sh -c 'until curl -f http://localhost:3000; do sleep 2; done' || exit 1
      
      - name: Check running containers
        run: docker compose ps
      
      # Keep services running for subsequent jobs
      - name: Save Docker Compose state
        run: echo "Services are running"
  
  playwright-api-tests:
    name: Playwright API Tests
    runs-on: ubuntu-latest
    needs: launch-application
    container:
      image: mcr.microsoft.com/playwright:v1.37.1-focal
      options: --network=host
    
    services:
      backend:
        image: golang:1.21
        ports:
          - 8080:8080
      frontend:
        image: node:20-alpine
        ports:
          - 3000:3000
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Start application services
        run: |
          docker compose up -d
      
      - name: Wait for backend API
        working-directory: tests-api
        run: npx wait-port http://localhost:8080/api/health --timeout=60000
      
      - name: Install dependencies
        working-directory: tests-api
        run: npm install
      
      - name: Run Playwright API tests
        working-directory: tests-api
        run: npx playwright test --reporter=html,junit
      
      - name: Publish API test results
        uses: EnricoMi/publish-unit-test-result-action@v2
        if: always()
        with:
          files: tests-api/test-results.xml
          check_name: Playwright API Test Results
      
      - name: Upload API test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: api-test-results
          path: tests-api/test-results.xml
      
      - name: Upload API test report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: playwright-api-report
          path: tests-api/playwright-report/
      
      - name: Cleanup
        if: always()
        run: docker compose down
  
  playwright-e2e-tests:
    name: Playwright E2E Tests
    runs-on: ubuntu-latest
    needs: launch-application
    container:
      image: mcr.microsoft.com/playwright:v1.37.1-focal
      options: --network=host --user root
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Start application services
        run: |
          docker compose up -d
      
      - name: Wait for frontend
        working-directory: tests-e2e
        run: npx wait-port http://localhost:3000/ --timeout=60000
      
      - name: Install dependencies
        working-directory: tests-e2e
        run: npm install
      
      - name: Install Playwright browsers
        working-directory: tests-e2e
        run: npx playwright install --with-deps chromium
      
      - name: Run Playwright E2E tests
        working-directory: tests-e2e
        run: npx playwright test --reporter=html,junit
      
      - name: Publish E2E test results
        uses: EnricoMi/publish-unit-test-result-action@v2
        if: always()
        with:
          files: tests-e2e/test-results.xml
          check_name: Playwright E2E Test Results
      
      - name: Upload E2E test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: e2e-test-results
          path: tests-e2e/test-results.xml
      
      - name: Upload E2E test report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: playwright-e2e-report
          path: tests-e2e/playwright-report/
      
      - name: Cleanup
        if: always()
        run: docker compose down
  
  performance-tests:
    name: Performance Tests
    runs-on: ubuntu-latest
    needs: launch-application
    container:
      image: grafana/k6:latest
      options: --network=host --user root --entrypoint=""
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Start application services
        run: |
          docker compose up -d
      
      - name: Wait for services
        run: sleep 10
      
      - name: Run K6 performance tests
        working-directory: tests-perf
        run: k6 run script.js
      
      - name: Upload performance test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: performance-test-results
          path: |
            tests-perf/test-results.xml
            tests-perf/perf-results.html
      
      - name: Cleanup
        if: always()
        run: docker compose down
  
  # Alternative approach using services instead of docker compose
  integration-tests:
    name: Integration Tests (Alternative)
    runs-on: ubuntu-latest
    needs: [backend-unit-tests, frontend-unit-tests]
    if: false  # Disabled by default, enable if preferred over docker-compose approach
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Build and start all services
        run: docker compose up --build -d
      
      - name: Wait for services to be ready
        run: |
          echo "Waiting for backend..."
          timeout 60 sh -c 'until curl -f http://localhost:8080/api/health; do sleep 2; done'
          echo "Waiting for frontend..."
          timeout 60 sh -c 'until curl -f http://localhost:3000; do sleep 2; done'
      
      - name: Install Playwright
        working-directory: tests-api
        run: npm install
      
      - name: Run API Tests
        working-directory: tests-api
        run: npx playwright test --reporter=html,junit
      
      - name: Install E2E test dependencies
        working-directory: tests-e2e
        run: |
          npm install
          npx playwright install --with-deps chromium
      
      - name: Run E2E Tests
        working-directory: tests-e2e
        run: npx playwright test --reporter=html,junit
      
      - name: Run Performance Tests
        run: |
          docker run --network=host -v $(pwd)/tests-perf:/tests grafana/k6:latest run /tests/script.js
      
      - name: Upload all test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: all-test-results
          path: |
            tests-api/test-results.xml
            tests-api/playwright-report/
            tests-e2e/test-results.xml
            tests-e2e/playwright-report/
            tests-perf/perf-results.html
      
      - name: Stop services
        if: always()
        run: docker compose down
  
  summary:
    name: Pipeline Summary
    runs-on: ubuntu-latest
    needs: [backend-unit-tests, frontend-unit-tests, playwright-api-tests, playwright-e2e-tests, performance-tests]
    if: always()
    
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
      
      - name: Display summary
        run: |
          echo "========================================="
          echo "CI/CD Pipeline Execution Complete"
          echo "========================================="
          echo "All stages have been executed."
          echo "Check individual job results for details."
